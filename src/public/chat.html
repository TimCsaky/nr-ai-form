<!DOCTYPE html>
<html>

<head>
    <title>Form Assistant</title>
    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
        }

        #chatbox {
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        #messages {
            flex: 1;
            /* overflow-y: auto; */
            padding: 10px;
        }

        #input {
            display: flex;
        }

        input[type=text] {
            flex: 1;
            padding: 8px;
        }

        button {
            padding: 8px;
        }

        #close-btn {
            top: -20px;
            right: 10px;
            position: fixed;
            cursor: pointer;
            padding: 10px 0px;
            background: #fff;
            color: #333;
            font-size: 1.5rem;
            font-weight: bold;
            border: none;
        }
    </style>
</head>

<body>
    <div id="chatbox">
        <button id="close-btn">&times;</button>
        <div id="fieldData"></div>
        <button onclick="requestFieldAssistance()">Help with this field</button>
        <div id="messages"></div>
    </div>
    </div>
    <script>

        window.chatState = window.chatState || {};

        // Listen for messages from the parent window
        window.addEventListener('message', (event) => {

            console.log('message received in iframe:');

            // Security check: ensure message is from the expected origin
            // TODO: uncomment following line
            // if (event.origin !== 'http://localhost:5173/static-form') return;

            // autheticating
            // receive auth token from parent page
            // TODO: can't we just get the token in this page instead??
            if (event.data.type === 'auth') {
                console.log('Received auth token in iframe:', event.data.token);
                // TODO: is it safe to store short-lived auth token in browser memory??
                window.chatState.token = event.data.token;
            }

            // receiving form data
            if (event.data.type === 'form') {
                console.log('Received form data in iframe:', event.data.data);

                // Save event.data and token to local state for use by other functions
                window.chatState = window.chatState || {};
                window.chatState.form = event.data.data;

                // show details of the focussed field (filtered from form schema and data)
                const fieldWithFocus = event.data.data.fieldWithFocus;
                const formSchema = event.data.data.formSchema;
                const formData = event.data.data.formData;
                const fieldSchema = formSchema.properties[fieldWithFocus];

                console.log('fieldSchema', fieldSchema);

                // display field data in the chat (for demo)
                const fieldValue = formData[fieldWithFocus];
                const fieldData = document.getElementById('fieldData');
                fieldData.innerHTML = `<strong>Form Schema:</strong> <pre>${JSON.stringify(formSchema, null, 2)} </pre><br>
                                       <strong>Form Data:</strong> <pre>${JSON.stringify(formData, null, 2)} </pre><br>
                                       <strong>Field Name:</strong> <pre>${fieldWithFocus}</pre> <br>
                                       <strong>Field Schema:</strong> <pre>${JSON.stringify(fieldSchema, null, 2)}</pre> <br>
                                       <strong>Field Value:</strong> <pre>${fieldValue || 'No value set'}</pre>`;

                document.getElementById('messages').innerHTML = "";
            }
            // example response back to parent:
            // event.source.postMessage({ type: 'response', text: 'Hello parent!' }, event.origin);            
        });


        function requestFieldAssistance() {

            console.log('window.chatState.form', window.chatState.form);

            // call the backend API to get assistance for the current field
            const formName = window.chatState.form.formSchema.name;
            const fieldName = window.chatState.form.fieldWithFocus;


            fetch(`http://localhost:3000/api/v2/${formName}/assist/${fieldName}`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${window.chatState.token}`,
                    'X-Form-Assist-Client': JSON.stringify({ client: window.chatState.form.client }),
                    'Content-Type': 'application/json'
                },
                // all the data we have about the form and client
                body: JSON.stringify(window.chatState.form),
            })
                .then(res => res.json())
                .then(data => {

                    console.log(data);

                    return appendMessage(data.aiResponse);
                })
                .catch(err => appendMessage('Error: ' + err.message));
        }

        function appendMessage(text) {
            const div = document.createElement('div');
            div.textContent = text;
            const messages = document.getElementById('messages');
            messages.appendChild(div);
            messages.scrollTop = messages.scrollHeight;
        }

        // Close button handler
        document.querySelector('#close-btn').onclick = () => {
            if (window.parent) {
                window.parent.postMessage({ type: 'hideChat' }, '*');
            }
        };

    </script>
</body>

</html
